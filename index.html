<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Inicio — Página personal</title>
    <style>
      :root {
        --bg: #0f1724;
        --card: #0b1220;
        --muted: #9aa4b2;
        --accent: #60a5fa;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: Inter, Segoe UI, Roboto, system-ui, -apple-system,
          "Helvetica Neue", Arial;
        color: #e6eef8;
        background: linear-gradient(180deg, #051023 0%, #071128 100%);
      }
      .wrap {
        max-width: 1100px;
        margin: 28px auto;
        padding: 18px;
      }
      header {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      h1 {
        font-size: 20px;
        margin: 0;
        color: #fff;
      }

      .top {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 18px;
        margin-top: 18px;
      }

      .search-card {
        background: rgba(255, 255, 255, 0.03);
        padding: 18px;
        border-radius: 12px;
        box-shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
      }
      .search {
        display: flex;
        gap: 8px;
      }
      .search input {
        flex: 1;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        background: transparent;
        color: #fff;
        font-size: 16px;
      }
      .search button {
        padding: 10px 14px;
        border-radius: 10px;
        border: 0;
        background: var(--accent);
        color: #042;
        cursor: pointer;
      }
      .hint {
        margin-top: 8px;
        color: var(--muted);
        font-size: 13px;
      }

      .weather-card {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        padding: 14px;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .weather-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .temp {
        font-size: 36px;
        color: #fff;
      }
      .cond {
        color: var(--muted);
        font-size: 14px;
      }
      .weather-controls {
        display: flex;
        gap: 8px;
      }
      .weather-controls input {
        padding: 8px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        background: transparent;
        color: #fff;
        width: 110px;
      }
      .btn {
        padding: 8px 10px;
        border-radius: 8px;
        border: 0;
        background: #111827;
        color: #fff;
        cursor: pointer;
      }

      .games {
        margin-top: 20px;
      }
      .games-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .games-list {
        display: flex;
        flex-direction: column;
        gap: 22px;
        margin-top: 18px;
      }
      .game {
        background: linear-gradient(90deg, rgba(255,255,255,0.03) 60%, rgba(96,165,250,0.04) 100%);
        padding: 22px 28px;
        border-radius: 18px;
        display: flex;
        align-items: center;
        gap: 28px;
        box-shadow: 0 4px 24px 0 rgba(2,6,23,0.13);
        transition: box-shadow 0.2s, transform 0.2s;
      }
      .game:hover {
        box-shadow: 0 8px 32px 0 rgba(96,165,250,0.10);
        transform: translateY(-2px) scale(1.012);
      }
      .game .cover {
        width: 92px;
        height: 92px;
        border-radius: 12px;
        overflow: hidden;
        background: #091224;
        flex-shrink: 0;
        box-shadow: 0 2px 12px 0 rgba(2,6,23,0.18);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .game .cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .game .cover .no-cover {
        color: var(--muted);
        font-size: 13px;
        text-align: center;
        padding: 0 6px;
      }
      .game .info {
        flex: 1;
        min-width: 0;
      }
      .game h3 {
        margin: 0 0 8px 0;
        font-size: 20px;
        color: #fff;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(2,6,23,0.10);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .game .meta {
        color: var(--muted);
        font-size: 15px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 14px;
        flex-wrap: wrap;
      }
      .game .score {
        font-weight: 700;
        font-size: 18px;
        padding: 2px 12px;
        border-radius: 8px;
        background: rgba(255,255,255,0.07);
        box-shadow: 0 1px 4px 0 rgba(2,6,23,0.10);
        margin-left: 4px;
        transition: color 0.2s, background 0.2s;
        min-width: 44px;
        text-align: center;
        letter-spacing: 0.5px;
      }
      .game .notes {
        color: var(--muted);
        font-size: 15px;
        margin-top: 2px;
        line-height: 1.5;
        max-width: 700px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .game .actions {
        display: flex;
        gap: 10px;
        margin-left: 18px;
      }
      .actions {
        display: flex;
        gap: 8px;
      }
      .small {
        padding: 6px 8px;
        border-radius: 8px;
        border: 0;
        background: #0b1220;
        color: #fff;
        cursor: pointer;
      }
      /* --- Responsive: juegos en móvil --- */
      @media (max-width: 600px) {
        .game {
          flex-direction: column;
          align-items: center;
          gap: 14px;
          padding: 16px 10px;
        }
        .game .score {
          margin-top: 8px;
          font-size: 16px;
          padding: 4px 10px;
        }
        .game .cover {
          width: 100%;
          max-width: 240px;
          aspect-ratio: 1 / 1;
          height: auto;
          margin: 0 auto 8px auto;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .game .cover img {
          width: 100%;
          height: 100%;
          object-fit: contain;
          display: block;
        }
        .game .info {
          min-width: 0;
          margin-top: 2rem;
        }
        .game h3 {
          font-size: 18px;
          white-space: normal;
          text-overflow: unset;
        }
        .game .meta {
          flex-direction: column;
          align-items: center;
          gap: 4px;
          font-size: 14px;
        }
        .game .notes {
          font-size: 14px;
          max-width: 100%;
          white-space: normal;
          text-overflow: unset;
        }
        .game .actions {
          margin-left: 0;
          margin-top: 10px;
          gap: 10px;
          width: 100%;
          justify-content: flex-end;
        }
        .game .actions button,
        .actions button.small {
          flex: 1 1 48%;
          min-width: 0;
          font-size: 15px;
          padding: 10px 0;
        }
      }

      /* modal */
      .modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(2, 6, 23, 0.6);
        z-index: 1000;
      }
      .modal.show {
        display: flex;
      }
      .modal-card {
        background: #041124;
        padding: 18px;
        border-radius: 12px;
        width: 520px;
        max-width: calc(100% - 40px);
        box-shadow: 0 8px 32px 0 rgba(2,6,23,0.18);
        position: relative;
      }
      .modal-card label {
        display: block;
        color: var(--muted);
        font-size: 13px;
        margin-top: 10px;
      }
      .modal-card input,
      .modal-card textarea,
      .modal-card select {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        background: rgba(255,255,255,0.03);
        color: #e6eef8;
        font-size: 15px;
        transition: border 0.2s, box-shadow 0.2s;
        box-shadow: 0 2px 8px rgba(2,6,23,0.10);
        appearance: none;
        outline: none;
      }
      .modal-card select:focus {
        border: 1.5px solid var(--accent);
        box-shadow: 0 0 0 2px rgba(96,165,250,0.15);
      }
      .modal-card select option {
        background: #0b1220;
        color: #e6eef8;
      }
      /* Custom arrow for select */
      .modal-card select {
        background-image: url('data:image/svg+xml;utf8,<svg fill="%239aa4b2" height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M7.293 8.293a1 1 0 011.414 0L10 9.586l1.293-1.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 010-1.414z"></path></svg>');
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 18px 18px;
      }
      .row {
        display: flex;
        gap: 8px;
      }
      .row > * {
        flex: 1;
      }

      footer {
        margin-top: 24px;
        color: var(--muted);
        font-size: 13px;
        text-align: center;
      }
      .weather-controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap; /* Permite que los elementos bajen a otra línea si no caben */
        justify-content: flex-start;
      }
      .weather-controls input,
      .weather-controls button {
        min-width: 0;
        flex: 1 1 110px; /* Permite que se reduzcan y crezcan */
        max-width: 140px;
        box-sizing: border-box;
      }
      @media (max-width: 600px) {
        .weather-controls input,
        .weather-controls button {
          flex: 1 1 100%;
          max-width: 100%;
        }
      }
      @media (max-width: 760px) {
        .top {
          grid-template-columns: 1fr;
        }
        .weather-card {
          order: 3;
        }
      }

      /* Estilos para el slider de puntuación */
      .modal-card input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 5px;
        background: #1a2332;
        border-radius: 3px;
        outline: none;
        margin: 0;
        box-shadow: 0 1px 4px 0 rgba(2,6,23,0.10);
        transition: background 0.2s;
        accent-color: var(--accent);
      }
      .modal-card input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #222c3a;
        border: 2px solid var(--accent);
        box-shadow: 0 2px 8px 0 rgba(96,165,250,0.13);
        cursor: pointer;
        transition: border 0.2s, background 0.2s;
      }
      .modal-card input[type="range"]:focus::-webkit-slider-thumb,
      .modal-card input[type="range"]:hover::-webkit-slider-thumb {
        border: 2px solid #fff;
        background: var(--accent);
      }
      .modal-card input[type="range"]::-ms-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #222c3a;
        border: 2px solid var(--accent);
        box-shadow: 0 2px 8px 0 rgba(96,165,250,0.13);
        cursor: pointer;
        transition: border 0.2s, background 0.2s;
      }
      .modal-card input[type="range"]:focus::-ms-thumb,
      .modal-card input[type="range"]:hover::-ms-thumb {
        border: 2px solid #fff;
        background: var(--accent);
      }
      .modal-card input[type="range"]::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #222c3a;
        border: 2px solid var(--accent);
        box-shadow: 0 2px 8px 0 rgba(96,165,250,0.13);
        cursor: pointer;
        transition: border 0.2s, background 0.2s;
      }
      .modal-card input[type="range"]:focus::-moz-range-thumb,
      .modal-card input[type="range"]:hover::-moz-range-thumb {
        border: 2px solid #fff;
        background: var(--accent);
      }
      .modal-card input[type="range"]::-ms-fill-lower {
        background: #222c3a;
        border-radius: 3px;
      }
      .modal-card input[type="range"]::-ms-fill-upper {
        background: #222c3a;
        border-radius: 3px;
      }
      .modal-card input[type="range"]:focus {
        outline: none;
      }
      .modal-card input[type="range"]::-ms-tooltip {
        display: none;
      }
      .modal-card .score-bubble {
        position: absolute;
        top: -32px;
        min-width: 32px;
        padding: 2px 8px;
        border-radius: 8px;
        background: #222c3a;
        color: var(--accent);
        font-size: 15px;
        font-weight: 600;
        box-shadow: 0 2px 8px 0 rgba(2,6,23,0.13);
        pointer-events: none;
        opacity: 0;
        transform: translateX(-50%) scale(0.95);
        transition: opacity 0.18s, transform 0.18s, left 0.12s;
        z-index: 2;
        left: 0;
      }
      .modal-card .score-slider-wrap.active .score-bubble {
        opacity: 1;
        transform: translateX(-50%) scale(1);
      }
      .modal-card .score-slider-wrap {
        position: relative;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .power-card {
        background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
        padding: 14px 16px 12px 16px;
        border-radius: 12px;
        box-shadow: 0 6px 18px rgba(2, 6, 23, 0.10);
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-bottom: 0px;
      }
      .power-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 2px;
      }
      .power-card table {
        width: 100%;
        border-collapse: collapse;
      }
      .power-card th, .power-card td {
        padding: 2px 4px;
        text-align: left;
      }
      .power-card tr:nth-child(even) td {
        background: rgba(255,255,255,0.02);
      }
      .power-card tr.now td {
        background: var(--accent);
        color: #041124;
        font-weight: 600;
      }

      /* Galería de miniaturas para portadas */
      #coverThumbGallery img {
        width: 48px;
        height: 48px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid #222c3a;
        cursor: pointer;
        transition: box-shadow 0.15s, border 0.15s, transform 0.15s;
        box-shadow: 0 1px 4px 0 rgba(2,6,23,0.10);
      }
      #coverThumbGallery img.selected {
        border: 2.5px solid var(--accent);
        box-shadow: 0 0 0 2px #60a5fa44;
        transform: scale(1.08);
      }
      #coverThumbGallery img:hover {
        border: 2.5px solid var(--accent);
        box-shadow: 0 0 0 2px #60a5fa44;
        transform: scale(1.08);
      }
      #coverPreviewWrap img {
        width: 96px;
        height: 96px;
        object-fit: cover;
        border-radius: 10px;
        border: 2px solid #222c3a;
        box-shadow: 0 2px 8px 0 rgba(2,6,23,0.13);
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>Inicio personal</h1>
      </header>

      <div class="top">
        <div class="search-card">
          <form id="googleForm" class="search" onsubmit="return false;">
            <input
              id="googleQuery"
              placeholder="Buscar en Google..."
              autocomplete="off"
            />
            <button id="btnSearch">Buscar</button>
          </form>
          <div class="hint">
            Pulsa Enter o el botón. El buscador abre los resultados in nueva
            pestaña.
          </div>
        </div>

        <div class="weather-card">
          <div class="weather-top">
            <div>
              <div style="font-size: 13px; color: var(--muted)">Tiempo</div>
              <div class="temp" id="wTemp">-- °C</div>
              <div class="cond" id="wDesc">Sin datos</div>
            </div>
            <div style="text-align: right">
              <div style="color: var(--muted); font-size: 12px">Ubicación</div>
              <div id="wPlace" style="font-weight: 600; color: #fff">
                No especificada
              </div>
            </div>
          </div>

          <div class="weather-controls">
            <button id="btnGeo" class="btn">Usar geolocalización</button>
            <input id="inpLat" placeholder="Lat" />
            <input id="inpLon" placeholder="Lon" />
            <button id="btnFetchWeather" class="btn">Actualizar</button>
          </div>
          <div style="font-size: 12px; color: var(--muted); margin-top: 6px">
            Consejo: guarda coordenadas si quieres una localización fija.
          </div>
        </div>
      </div>

      <section class="games">
        <div class="games-header">
          <h2 style="color: #fff; margin: 0">Juegos finalizados</h2>
          <div style="display: flex; gap: 8px; align-items: center">
            <button id="btnAdd" class="small">Añadir juego</button>
            <button id="btnExport" class="small">Exportar JSON</button>
            <label
              class="small"
              style="
                display: inline-flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
              "
            >
              <input
                id="fileImport"
                type="file"
                accept="application/json"
                style="display: none"
              />Importar
            </label>
          </div>
        </div>

        <div class="games-list" id="gamesList"></div>
      </section>

      <footer>Hecho para uso personal — versión prototipo.</footer>
    </div>

    <!-- modal form -->
    <div id="modal" class="modal" role="dialog" aria-hidden="true">
      <div class="modal-card">
        <h3 id="modalTitle">Añadir juego</h3>
        <form id="gameForm">
          <label>Título</label>
          <input id="gTitle" required />
          <div class="row">
            <div>
              <label>Plataforma</label>
              <select id="gPlatform">
                <option value="">Selecciona plataforma</option>
                <option>PC</option>
                <option>PlayStation 5</option>
                <option>PlayStation 4</option>
                <option>PlayStation 3</option>
                <option>Xbox Series X|S</option>
                <option>Xbox One</option>
                <option>Xbox 360</option>
                <option>Nintendo Switch</option>
                <option>Wii U</option>
                <option>Wii</option>
                <option>Nintendo 3DS</option>
                <option>Nintendo DS</option>
                <option>Android</option>
                <option>iOS</option>
                <option>Steam Deck</option>
                <option>Otro</option>
              </select>
            </div>
            <div>
              <label>Fecha finalizado</label>
              <input id="gDate" type="date" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Puntuación (0-100)</label>
              <div class="score-slider-wrap" style="flex:1;">
                <input id="gScore" type="range" min="0" max="100" step="1" value="0" />
                <span class="score-bubble" id="gScoreBubble">0</span>
                <span id="gScoreValue" style="min-width:36px;text-align:right;font-size:15px;color:var(--accent);font-weight:600;position:relative;top:1px;">0</span>
              </div>
            </div>
            <div>
              <label>Horas jugadas</label>
              <input id="gHours" type="number" min="0" />
            </div>
          </div>
          <label
            >Cover URL (opcional) — Si lo dejas vacío buscaré automáticamente la
            portada.</label
          >
          <input id="gCover" placeholder="https://...jpg" />
          <div style="margin-top:8px;">
            <div style="display:flex;gap:8px;align-items:center;">
              <button type="button" id="btnFindCover" class="small">
                Buscar portada ahora
              </button>
              <div id="coverStatus" style="font-size: 13px; color: var(--muted)">
                Estado: sin buscar
              </div>
            </div>
            <div id="coverThumbGallery" style="display:flex;gap:8px;margin:10px 0 8px 0;"></div>
            <div id="coverPreviewWrap" style="display:flex;justify-content:center;"></div>
          </div>
          <label>Notas</label>
          <textarea id="gNotes" rows="3"></textarea>

          <div
            style="
              display: flex;
              gap: 8px;
              justify-content: flex-end;
              margin-top: 12px;
            "
          >
            <button type="button" id="btnCancel" class="small">Cancelar</button>
            <button type="submit" class="small">Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal de confirmación para eliminar juego -->
    <div id="confirmModal" class="modal" role="dialog" aria-hidden="true">
      <div class="modal-card" style="max-width:340px;padding:28px 24px;text-align:center;">
        <div style="font-size:18px;font-weight:600;color:#fff;margin-bottom:10px;">¿Eliminar juego?</div>
        <div id="confirmGameTitle" style="color:var(--muted);font-size:15px;margin-bottom:18px;"></div>
        <div style="display:flex;gap:12px;justify-content:center;">
          <button id="btnConfirmDelete" class="small" style="background:#ef4444;color:#fff;min-width:80px;">Eliminar</button>
          <button id="btnCancelDelete" class="small" style="background:#222c3a;color:#fff;min-width:80px;">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Firebase App (core) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <!-- Firebase Realtime Database -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    <script>
      // =====================
      // Configuración y Constantes
      // =====================
      const FIREBASE_CONFIG = {
        apiKey: "TU_API_KEY",
        authDomain: "juegos-completados-a3005.firebaseapp.com",
        databaseURL: "https://juegos-completados-a3005-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "juegos-completados-a3005",
        storageBucket: "juegos-completados-a3005.appspot.com",
        messagingSenderId: "TU_MESSAGING_SENDER_ID",
        appId: "TU_APP_ID"
      };
      const RAWG_API_KEY = "f9f8f4e16c9740248b1c67e71720e801";
      const WEATHER_KEY = "homepage_weather_loc";
      const SELECTORS = {
        gamesList: "#gamesList",
        modal: "#modal",
        modalTitle: "#modalTitle",
        gameForm: "#gameForm",
        gTitle: "#gTitle",
        gPlatform: "#gPlatform",
        gDate: "#gDate",
        gScore: "#gScore",
        gScoreValue: "#gScoreValue",
        gScoreBubble: "#gScoreBubble",
        gHours: "#gHours",
        gCover: "#gCover",
        gNotes: "#gNotes",
        coverStatus: "#coverStatus",
        btnAdd: "#btnAdd",
        btnCancel: "#btnCancel",
        btnFindCover: "#btnFindCover",
        btnExport: "#btnExport",
        fileImport: "#fileImport",
        btnGeo: "#btnGeo",
        inpLat: "#inpLat",
        inpLon: "#inpLon",
        btnFetchWeather: "#btnFetchWeather",
        wTemp: "#wTemp",
        wDesc: "#wDesc",
        wPlace: "#wPlace",
        confirmModal: "#confirmModal",
        btnCancelDelete: "#btnCancelDelete",
        btnConfirmDelete: "#btnConfirmDelete",
        confirmGameTitle: "#confirmGameTitle",
        googleForm: "#googleForm",
        googleQuery: "#googleQuery",
        btnSearch: "#btnSearch"
      };

      // =====================
      // Inicialización Firebase
      // =====================
      firebase.initializeApp(FIREBASE_CONFIG);
      const db = firebase.database();

      // =====================
      // Helpers
      // =====================
      const $ = (sel) => document.querySelector(sel);
      const fmtDate = (d) => {
        if (!d) return "-";
        const date = new Date(d);
        if (isNaN(date)) return "-";
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = String(date.getFullYear()).slice(-2);
        return `${day}/${month}/${year}`;
      };
      function escapeHtml(s) {
        if (!s) return "";
        return String(s).replace(/[&<>"]|'/g, (m) => ({
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;"
        })[m]);
      }
      function debounce(fn, wait) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), wait);
        };
      }

      // =====================
      // Estado global
      // =====================
      let games = [];
      let editingId = null;
      let pendingDeleteId = null;
      const coverCache = {};

      // =====================
      // Weather mapping (Open-Meteo)
      // =====================
      const weatherCodes = {
        0: "Cielo despejado",
        1: "Principalmente despejado",
        2: "Parcialmente nublado",
        3: "Nublado",
        45: "Niebla",
        48: "Neblina con depósitos de hielo",
        51: "Llovizna ligera",
        53: "Llovizna moderada",
        55: "Llovizna densa",
        61: "Lluvia ligera",
        63: "Lluvia moderada",
        65: "Lluvia intensa",
        71: "Nieve ligera",
        73: "Nieve moderada",
        75: "Nieve intensa",
        80: "Chubascos ligeros",
        81: "Chubascos",
        82: "Chubascos intensos",
        95: "Tormenta",
        96: "Tormenta con granizo ligero",
        99: "Tormenta con granizo fuerte"
      };

      // =====================
      // CRUD y almacenamiento
      // =====================
      function loadGames() {
        db.ref('games').once('value').then(snapshot => {
          games = snapshot.val() || [];
          renderGames();
        }).catch(() => {
          games = [];
          renderGames();
        });
      }
      function saveGames() {
        db.ref('games').set(games);
      }

      // =====================
      // Renderizado de juegos
      // =====================
      function renderGames() {
        const container = $(SELECTORS.gamesList);
        container.innerHTML = "";
        if (!games.length) {
          container.innerHTML = '<div style="color:var(--muted)">No hay juegos todavía. Añade el primero.</div>';
          return;
        }
        const sorted = [...games].sort((a, b) => (b.date || "").localeCompare(a.date || ""));
        for (const g of sorted) {
          const div = document.createElement("div");
          div.className = "game";
          // Color score: de rojo (#ef4444) a verde (#22c55e)
          let scoreColor = '#9aa4b2';
          if (typeof g.score === 'number') {
            const r1=239,g1=68,b1=68, r2=34,g2=197,b2=94;
            const t = Math.max(0, Math.min(1, g.score/100));
            const r = Math.round(r1 + (r2 - r1) * t);
            const gC = Math.round(g1 + (g2 - g1) * t);
            const b = Math.round(b1 + (b2 - b1) * t);
            scoreColor = `rgb(${r},${gC},${b})`;
          }
          div.innerHTML = `
            <div class="cover">
              ${g.cover
                ? `<img src="${g.cover}" alt="cover">`
                : `<div class="no-cover">No cover</div>`
              }
            </div>
            <div class="info">
              <h3>${escapeHtml(g.title)}</h3>
              <div class="meta">
                <span>${escapeHtml(g.platform || "Sin plataforma")}</span>
                <span>${fmtDate(g.date)}</span>
                <span class="score" style="color:${scoreColor};background:rgba(255,255,255,0.10)">${g.score ?? "-"}</span>
              </div>
              <div class="notes">${escapeHtml(g.notes || "").slice(0, 180)}</div>
            </div>
            <div class="actions">
              <button class="small" onclick="openEdit('${g.id}')">Editar</button>
              <button class="small" onclick="deleteGame('${g.id}')">Borrar</button>
            </div>
          `;
          container.appendChild(div);
        }
      }

      // =====================
      // CRUD helpers
      // =====================
      function addGame(payload) {
        const entry = Object.assign({
          id: String(Date.now()),
          title: payload.title || "Sin título",
          platform: payload.platform || "",
          date: payload.date || "",
          score: payload.score !== undefined ? Number(payload.score) : null,
          hours: payload.hours || null,
          cover: payload.cover || "",
          notes: payload.notes || "",
        });
        games.push(entry);
        saveGames();
        renderGames();
      }
      function updateGame(id, payload) {
        const idx = games.findIndex((x) => x.id === id);
        if (idx === -1) return;
        games[idx] = Object.assign({}, games[idx], payload);
        saveGames();
        renderGames();
      }
      function deleteGame(id) {
        const g = games.find(x => x.id === id);
        if (!g) return;
        pendingDeleteId = id;
        $(SELECTORS.confirmGameTitle).textContent = g.title ? `"${g.title}"` : '';
        $(SELECTORS.confirmModal).classList.add('show');
        $(SELECTORS.confirmModal).setAttribute('aria-hidden', 'false');
      }
      function closeConfirmModal() {
        $(SELECTORS.confirmModal).classList.remove('show');
        $(SELECTORS.confirmModal).setAttribute('aria-hidden', 'true');
        pendingDeleteId = null;
      }
      function openEdit(id) {
        const g = games.find((x) => x.id === id);
        if (!g) return;
        editingId = id;
        $(SELECTORS.modalTitle).textContent = "Editar juego";
        $(SELECTORS.gTitle).value = g.title;
        $(SELECTORS.gPlatform).value = g.platform || "";
        $(SELECTORS.gDate).value = g.date || "";
        $(SELECTORS.gScore).value = g.score ?? 0;
        updateScoreUI(g.score ?? 0);
        $(SELECTORS.gHours).value = g.hours ?? "";
        $(SELECTORS.gCover).value = g.cover || "";
        $(SELECTORS.gNotes).value = g.notes || "";
        $(SELECTORS.coverStatus).textContent = g.cover ? "Portada ya presente" : "Sin portada";
        $(SELECTORS.modal).classList.add("show");
        $(SELECTORS.modal).setAttribute("aria-hidden", "false");
      }

      // =====================
      // Export / Import
      // =====================
      function exportJSON() {
        const blob = new Blob([JSON.stringify(games, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "juegos_export.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
      function importJSON(file) {
        const r = new FileReader();
        r.onload = (e) => {
          try {
            const parsed = JSON.parse(e.target.result);
            if (!Array.isArray(parsed)) throw new Error("Formato inválido");
            for (const p of parsed) {
              if (!p.title) p.title = "Sin título";
              if (!p.id) p.id = String(Date.now() + Math.random());
            }
            games = parsed;
            saveGames();
            renderGames();
            alert("Importado correctamente");
          } catch (err) {
            alert("Error al importar: " + err.message);
          }
        };
        r.readAsText(file);
      }

      // =====================
      // RAWG cover search
      // =====================
      // RAWG cover search: devuelve array de imágenes (máx 4)
      async function fetchCoverRAWG(title) {
        const q = title && title.trim();
        if (!q) return [];
        if (coverCache[q]) return coverCache[q];
        const base = "https://api.rawg.io/api/games";
        const params = new URLSearchParams({ search: q, page_size: "3" });
        if (RAWG_API_KEY) params.set("key", RAWG_API_KEY);
        const url = `${base}?${params.toString()}`;
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error("RAWG no responde: " + res.status);
          const data = await res.json();
          let imgs = [];
          if (data && data.results && data.results.length) {
            for (const r of data.results) {
              if (r.background_image) imgs.push(r.background_image);
              if (r.short_screenshots && Array.isArray(r.short_screenshots)) {
                for (const s of r.short_screenshots) {
                  if (s.image && !imgs.includes(s.image)) imgs.push(s.image);
                }
              }
            }
          }
          imgs = imgs.filter(Boolean).slice(0,4);
          coverCache[q] = imgs;
          return imgs;
        } catch (err) {
          console.warn("Error buscando portada RAWG:", err);
        }
        coverCache[q] = [];
        return [];
      }

      // =====================
      // Weather
      // =====================
      async function fetchWeather(lat, lon) {
        try {
          $(SELECTORS.wTemp).textContent = "...";
          $(SELECTORS.wDesc).textContent = "Cargando...";
          const url = `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&current_weather=true&temperature_unit=celsius&timezone=auto`;
          const res = await fetch(url);
          if (!res.ok) throw new Error("Respuesta del servidor no válida");
          const data = await res.json();
          if (data && data.current_weather) {
            const cw = data.current_weather;
            $(SELECTORS.wTemp).textContent = Math.round(cw.temperature) + " °C";
            $(SELECTORS.wDesc).textContent = (weatherCodes[cw.weathercode] || "Condición #" + cw.weathercode) + " · velocidad " + cw.windspeed + " m/s";
            $(SELECTORS.wPlace).textContent = `Lat ${lat.toFixed(4)}, Lon ${lon.toFixed(4)}`;
            localStorage.setItem(WEATHER_KEY, JSON.stringify({ lat, lon }));
          } else {
            $(SELECTORS.wDesc).textContent = "No hay datos actuales";
          }
        } catch (err) {
          $(SELECTORS.wDesc).textContent = "Error al obtener tiempo";
          console.error(err);
        }
      }
      function tryLoadWeatherFromStorage() {
        const raw = localStorage.getItem(WEATHER_KEY);
        if (!raw) return false;
        try {
          const s = JSON.parse(raw);
          if (s.lat && s.lon) {
            $(SELECTORS.inpLat).value = s.lat;
            $(SELECTORS.inpLon).value = s.lon;
            fetchWeather(Number(s.lat), Number(s.lon));
            return true;
          }
        } catch (e) {}
        return false;
      }
      function showDefaultWeatherIfNeeded() {
        const loaded = tryLoadWeatherFromStorage();
        if (!loaded) {
          const lat = 40.3989;
          const lon = -3.6944;
          $(SELECTORS.inpLat).value = lat;
          $(SELECTORS.inpLon).value = lon;
          fetchWeather(lat, lon);
        }
      }

      // =====================
      // UI: Slider puntuación
      // =====================
      function updateScoreUI(val) {
        const scoreSlider = document.getElementById("gScore");
        const scoreValue = document.getElementById("gScoreValue");
        const scoreBubble = document.getElementById("gScoreBubble");
        const scoreWrap = scoreSlider ? scoreSlider.closest('.score-slider-wrap') : null;
        if (!scoreSlider || !scoreValue || !scoreBubble || !scoreWrap) return;
        scoreValue.textContent = val;
        scoreBubble.textContent = val;
        const min = Number(scoreSlider.min);
        const max = Number(scoreSlider.max);
        const percent = (val - min) / (max - min);
        const sliderRect = scoreSlider.getBoundingClientRect();
        const thumbWidth = 16;
        const usableWidth = sliderRect.width - thumbWidth;
        let px = percent * usableWidth + thumbWidth / 2;
        px = Math.max(thumbWidth / 2, Math.min(sliderRect.width - thumbWidth / 2, px));
        scoreBubble.style.left = px + 'px';
      }

      // =====================
      // Inicialización y eventos
      // =====================
      document.addEventListener("DOMContentLoaded", () => {
        loadGames();
        renderGames();

        // Buscador Google
        $(SELECTORS.btnSearch).addEventListener("click", doSearch);
        $(SELECTORS.googleQuery).addEventListener("keydown", (e) => {
          if (e.key === "Enter") doSearch();
        });

        // Modal añadir/editar juego
        $(SELECTORS.btnAdd).addEventListener("click", () => {
          editingId = null;
          $(SELECTORS.modalTitle).textContent = "Añadir juego";
          $(SELECTORS.gameForm).reset();
          const today = new Date().toISOString().slice(0, 10);
          $(SELECTORS.gDate).value = today;
          $(SELECTORS.coverStatus).textContent = "sin buscar";
          $(SELECTORS.gScore).value = 0;
          $(SELECTORS.gScoreValue).textContent = 0;
          updateScoreUI(0);
          $(SELECTORS.modal).classList.add("show");
          $(SELECTORS.modal).setAttribute("aria-hidden", "false");
          $(SELECTORS.gTitle).focus();
        });
        $(SELECTORS.btnCancel).addEventListener("click", () => {
          $(SELECTORS.modal).classList.remove("show");
          $(SELECTORS.modal).setAttribute("aria-hidden", "true");
        });

        // Buscar portada ahora (muestra opciones y previsualización)
        $(SELECTORS.btnFindCover).addEventListener("click", async () => {
          const title = $(SELECTORS.gTitle).value.trim();
          if (!title) {
            alert("Introduce primero el título");
            return;
          }
          $(SELECTORS.coverStatus).textContent = "Buscando...";
          const gallery = document.getElementById('coverThumbGallery');
          const previewWrap = document.getElementById('coverPreviewWrap');
          gallery.innerHTML = '';
          previewWrap.innerHTML = '';
          try {
            const imgs = await fetchCoverRAWG(title);
            if (imgs && imgs.length) {
              imgs.forEach((imgUrl, idx) => {
                const thumb = document.createElement('img');
                thumb.src = imgUrl;
                thumb.title = 'Elegir esta portada';
                thumb.addEventListener('click', () => {
                  $(SELECTORS.gCover).value = imgUrl;
                  updateCoverPreview();
                  gallery.querySelectorAll('img').forEach(img => img.classList.remove('selected'));
                  thumb.classList.add('selected');
                });
                // Si es la actual, resaltar
                if ($(SELECTORS.gCover).value === imgUrl || (idx === 0 && !$(SELECTORS.gCover).value)) {
                  thumb.classList.add('selected');
                }
                gallery.appendChild(thumb);
              });
              // Si no hay portada seleccionada, poner la primera
              if (!$(SELECTORS.gCover).value) {
                $(SELECTORS.gCover).value = imgs[0];
                updateCoverPreview();
                gallery.querySelector('img').classList.add('selected');
              } else {
                updateCoverPreview();
              }
              $(SELECTORS.coverStatus).textContent = "Elige la portada correcta";
            } else {
              $(SELECTORS.coverStatus).textContent = "No encontrada (usa URL manualmente o guarda y luego edita)";
            }
          } catch (e) {
            $(SELECTORS.coverStatus).textContent = "Error al buscar";
            console.error(e);
          }
        });

        // Previsualización de portada al cambiar input manualmente
        $(SELECTORS.gCover).addEventListener('input', () => {
          var val = $(SELECTORS.gCover).value.trim();
          document.getElementById('coverThumbGallery').querySelectorAll('img').forEach(img => {
            img.classList.remove('selected');
            if (img.src === val) {
              img.classList.add('selected');
            }
          });
          updateCoverPreview();
        });
        // Mostrar previsualización al abrir modal de edición/añadir
        function updateCoverPreview() {
          const url = $(SELECTORS.gCover).value.trim();
          const previewWrap = document.getElementById('coverPreviewWrap');
          previewWrap.innerHTML = '';
          if (url) {
            const img = document.createElement('img');
            img.src = url;
            img.alt = 'Previsualización de portada';
            previewWrap.appendChild(img);
          }
        }
        // Llamar al abrir modal
        const origOpenEdit = window.openEdit;
        window.openEdit = function(id) {
          origOpenEdit(id);
          setTimeout(() => {
            document.getElementById('coverThumbGallery').innerHTML = '';
            updateCoverPreview();
          }, 50);
        };
        // Al abrir modal de añadir
        $(SELECTORS.btnAdd).addEventListener('click', () => {
          setTimeout(() => {
            document.getElementById('coverThumbGallery').innerHTML = '';
            updateCoverPreview();
          }, 50);
        });

        // Guardar juego (submit form)
        $(SELECTORS.gameForm).addEventListener("submit", async (e) => {
          e.preventDefault();
          const payload = {
            title: $(SELECTORS.gTitle).value.trim(),
            platform: $(SELECTORS.gPlatform).value.trim(),
            date: $(SELECTORS.gDate).value || "",
            score: $(SELECTORS.gScore).value ? Number($(SELECTORS.gScore).value) : null,
            hours: $(SELECTORS.gHours).value ? Number($(SELECTORS.gHours).value) : null,
            cover: $(SELECTORS.gCover).value.trim(),
            notes: $(SELECTORS.gNotes).value.trim(),
          };
          if (!payload.cover && payload.title) {
            $(SELECTORS.coverStatus).textContent = "Buscando portada...";
            try {
              const img = await fetchCoverRAWG(payload.title);
              if (img) {
                payload.cover = img;
                $(SELECTORS.coverStatus).textContent = "Portada encontrada y asignada";
              } else {
                $(SELECTORS.coverStatus).textContent = "No se encontró portada automáticamente";
              }
            } catch (err) {
              console.warn(err);
              $(SELECTORS.coverStatus).textContent = "Error buscando portada";
            }
          }
          if (editingId) {
            updateGame(editingId, payload);
            editingId = null;
          } else {
            addGame(payload);
          }
          $(SELECTORS.modal).classList.remove("show");
          $(SELECTORS.modal).setAttribute("aria-hidden", "true");
        });

        // Exportar/Importar
        $(SELECTORS.btnExport).addEventListener("click", exportJSON);
        $(SELECTORS.fileImport).addEventListener("change", (e) => {
          const f = e.target.files[0];
          if (f) importJSON(f);
          e.target.value = "";
        });

        // Weather
        $(SELECTORS.btnGeo).addEventListener("click", () => {
          if (!navigator.geolocation) {
            alert("Geolocalización no disponible en este navegador");
            return;
          }
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const lat = pos.coords.latitude;
              const lon = pos.coords.longitude;
              $(SELECTORS.inpLat).value = lat;
              $(SELECTORS.inpLon).value = lon;
              fetchWeather(lat, lon);
            },
            (err) => {
              alert("Error geolocalización: " + err.message);
            }
          );
        });
        $(SELECTORS.btnFetchWeather).addEventListener("click", () => {
          const lat = parseFloat($(SELECTORS.inpLat).value);
          const lon = parseFloat($(SELECTORS.inpLon).value);
          if (Number.isFinite(lat) && Number.isFinite(lon)) {
            fetchWeather(lat, lon);
          } else {
            alert("Introduce coordenadas válidas");
          }
        });
        tryLoadWeatherFromStorage();
        showDefaultWeatherIfNeeded();

        // Atajo de foco buscador
        document.addEventListener("keydown", (e) => {
          if (
            e.key === "/" &&
            document.activeElement.tagName !== "INPUT" &&
            document.activeElement.tagName !== "TEXTAREA"
          ) {
            e.preventDefault();
            $(SELECTORS.googleQuery).focus();
          }
        });

        // Confirmación de borrado
        $(SELECTORS.btnCancelDelete).addEventListener('click', closeConfirmModal);
        $(SELECTORS.confirmModal).addEventListener('click', (e) => {
          if (e.target === $(SELECTORS.confirmModal)) closeConfirmModal();
        });
        $(SELECTORS.btnConfirmDelete).addEventListener('click', () => {
          if (pendingDeleteId) {
            games = games.filter(x => x.id !== pendingDeleteId);
            saveGames();
            renderGames();
            closeConfirmModal();
          }
        });

        // Slider puntuación: sincronizar valor y burbuja
        const scoreSlider = $(SELECTORS.gScore);
        const scoreWrap = scoreSlider.closest('.score-slider-wrap');
        scoreSlider.addEventListener("input", (e) => {
          updateScoreUI(e.target.value);
        });
        scoreSlider.addEventListener("mousedown", () => {
          scoreWrap.classList.add('active');
          updateScoreUI(scoreSlider.value);
        });
        scoreSlider.addEventListener("touchstart", () => {
          scoreWrap.classList.add('active');
          updateScoreUI(scoreSlider.value);
        });
        ["mouseup","mouseleave","touchend","blur"].forEach(ev => {
          scoreSlider.addEventListener(ev, () => {
            scoreWrap.classList.remove('active');
            updateScoreUI(scoreSlider.value);
          });
        });
        const modal = $(SELECTORS.modal);
        const observer = new MutationObserver(() => {
          if (modal.classList.contains('show')) {
            setTimeout(() => updateScoreUI(scoreSlider.value), 10);
          }
        });
        observer.observe(modal, { attributes: true, attributeFilter: ['class'] });
        window.addEventListener('resize', () => updateScoreUI(scoreSlider.value));
        updateScoreUI(scoreSlider.value);
      });

      function doSearch() {
        const q = $(SELECTORS.googleQuery).value.trim();
        if (!q) return;
        const url = "https://www.google.com/search?q=" + encodeURIComponent(q);
        window.open(url, "_blank");
      }

      // Exponer funciones globales para botones inline
      window.openEdit = openEdit;
      window.deleteGame = deleteGame;
    </script>
  </body>
</html>
