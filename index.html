<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Inicio — Página personal</title>
    <style>
      :root {
        --bg: #0f1724;
        --card: #0b1220;
        --muted: #9aa4b2;
        --accent: #60a5fa;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: Inter, Segoe UI, Roboto, system-ui, -apple-system,
          "Helvetica Neue", Arial;
        color: #e6eef8;
        background: linear-gradient(180deg, #051023 0%, #071128 100%);
      }
      .wrap {
        max-width: 1100px;
        margin: 28px auto;
        padding: 18px;
      }
      header {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      h1 {
        font-size: 20px;
        margin: 0;
        color: #fff;
      }

      .top {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 18px;
        margin-top: 18px;
      }

      .search-card {
        background: rgba(255, 255, 255, 0.03);
        padding: 18px;
        border-radius: 12px;
        box-shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
      }
      .search {
        display: flex;
        gap: 8px;
      }
      .search input {
        flex: 1;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        background: transparent;
        color: #fff;
        font-size: 16px;
      }
      .search button {
        padding: 10px 14px;
        border-radius: 10px;
        border: 0;
        background: var(--accent);
        color: #042;
        cursor: pointer;
      }
      .hint {
        margin-top: 8px;
        color: var(--muted);
        font-size: 13px;
      }

      .weather-card {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        padding: 14px;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .weather-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .temp {
        font-size: 36px;
        color: #fff;
      }
      .cond {
        color: var(--muted);
        font-size: 14px;
      }
      .weather-controls {
        display: flex;
        gap: 8px;
      }
      .weather-controls input {
        padding: 8px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        background: transparent;
        color: #fff;
        width: 110px;
      }
      .btn {
        padding: 8px 10px;
        border-radius: 8px;
        border: 0;
        background: #111827;
        color: #fff;
        cursor: pointer;
      }

      .games {
        margin-top: 20px;
      }
      .games-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .games-list {
        display: flex;
        flex-direction: column;
        gap: 22px;
        margin-top: 18px;
      }
      .game {
        background: linear-gradient(90deg, rgba(255,255,255,0.03) 60%, rgba(96,165,250,0.04) 100%);
        padding: 22px 28px;
        border-radius: 18px;
        display: flex;
        align-items: center;
        gap: 28px;
        box-shadow: 0 4px 24px 0 rgba(2,6,23,0.13);
        transition: box-shadow 0.2s, transform 0.2s;
      }
      .game:hover {
        box-shadow: 0 8px 32px 0 rgba(96,165,250,0.10);
        transform: translateY(-2px) scale(1.012);
      }
      .game .cover {
        width: 92px;
        height: 92px;
        border-radius: 12px;
        overflow: hidden;
        background: #091224;
        flex-shrink: 0;
        box-shadow: 0 2px 12px 0 rgba(2,6,23,0.18);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .game .cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .game .cover .no-cover {
        color: var(--muted);
        font-size: 13px;
        text-align: center;
        padding: 0 6px;
      }
      .game .info {
        flex: 1;
        min-width: 0;
      }
      .game h3 {
        margin: 0 0 8px 0;
        font-size: 20px;
        color: #fff;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(2,6,23,0.10);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .game .meta {
        color: var(--muted);
        font-size: 15px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 14px;
        flex-wrap: wrap;
      }
      .game .score {
        font-weight: 700;
        font-size: 18px;
        padding: 2px 12px;
        border-radius: 8px;
        background: rgba(255,255,255,0.07);
        box-shadow: 0 1px 4px 0 rgba(2,6,23,0.10);
        margin-left: 4px;
        transition: color 0.2s, background 0.2s;
        min-width: 44px;
        text-align: center;
        letter-spacing: 0.5px;
      }
      .game .notes {
        color: var(--muted);
        font-size: 15px;
        margin-top: 2px;
        line-height: 1.5;
        max-width: 700px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .game .actions {
        display: flex;
        gap: 10px;
        margin-left: 18px;
      }
      .actions {
        display: flex;
        gap: 8px;
      }
      .small {
        padding: 6px 8px;
        border-radius: 8px;
        border: 0;
        background: #0b1220;
        color: #fff;
        cursor: pointer;
      }

      /* modal */
      .modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(2, 6, 23, 0.6);
        z-index: 1000;
      }
      .modal.show {
        display: flex;
      }
      .modal-card {
        background: #041124;
        padding: 18px;
        border-radius: 12px;
        width: 520px;
        max-width: calc(100% - 40px);
        box-shadow: 0 8px 32px 0 rgba(2,6,23,0.18);
        position: relative;
      }
      .modal-card label {
        display: block;
        color: var(--muted);
        font-size: 13px;
        margin-top: 10px;
      }
      .modal-card input,
      .modal-card textarea,
      .modal-card select {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        background: rgba(255,255,255,0.03);
        color: #e6eef8;
        font-size: 15px;
        transition: border 0.2s, box-shadow 0.2s;
        box-shadow: 0 2px 8px rgba(2,6,23,0.10);
        appearance: none;
        outline: none;
      }
      .modal-card select:focus {
        border: 1.5px solid var(--accent);
        box-shadow: 0 0 0 2px rgba(96,165,250,0.15);
      }
      .modal-card select option {
        background: #0b1220;
        color: #e6eef8;
      }
      /* Custom arrow for select */
      .modal-card select {
        background-image: url('data:image/svg+xml;utf8,<svg fill="%239aa4b2" height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M7.293 8.293a1 1 0 011.414 0L10 9.586l1.293-1.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 010-1.414z"></path></svg>');
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 18px 18px;
      }
      .row {
        display: flex;
        gap: 8px;
      }
      .row > * {
        flex: 1;
      }

      footer {
        margin-top: 24px;
        color: var(--muted);
        font-size: 13px;
        text-align: center;
      }
      .weather-controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap; /* Permite que los elementos bajen a otra línea si no caben */
        justify-content: flex-start;
      }
      .weather-controls input,
      .weather-controls button {
        min-width: 0;
        flex: 1 1 110px; /* Permite que se reduzcan y crezcan */
        max-width: 140px;
        box-sizing: border-box;
      }
      @media (max-width: 600px) {
        .weather-controls input,
        .weather-controls button {
          flex: 1 1 100%;
          max-width: 100%;
        }
      }
      @media (max-width: 760px) {
        .top {
          grid-template-columns: 1fr;
        }
        .weather-card {
          order: 3;
        }
      }

      /* Estilos para el slider de puntuación */
      .modal-card input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 5px;
        background: #1a2332;
        border-radius: 3px;
        outline: none;
        margin: 0;
        box-shadow: 0 1px 4px 0 rgba(2,6,23,0.10);
        transition: background 0.2s;
        accent-color: var(--accent);
      }
      .modal-card input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #222c3a;
        border: 2px solid var(--accent);
        box-shadow: 0 2px 8px 0 rgba(96,165,250,0.13);
        cursor: pointer;
        transition: border 0.2s, background 0.2s;
      }
      .modal-card input[type="range"]:focus::-webkit-slider-thumb,
      .modal-card input[type="range"]:hover::-webkit-slider-thumb {
        border: 2px solid #fff;
        background: var(--accent);
      }
      .modal-card input[type="range"]::-ms-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #222c3a;
        border: 2px solid var(--accent);
        box-shadow: 0 2px 8px 0 rgba(96,165,250,0.13);
        cursor: pointer;
        transition: border 0.2s, background 0.2s;
      }
      .modal-card input[type="range"]:focus::-ms-thumb,
      .modal-card input[type="range"]:hover::-ms-thumb {
        border: 2px solid #fff;
        background: var(--accent);
      }
      .modal-card input[type="range"]::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #222c3a;
        border: 2px solid var(--accent);
        box-shadow: 0 2px 8px 0 rgba(96,165,250,0.13);
        cursor: pointer;
        transition: border 0.2s, background 0.2s;
      }
      .modal-card input[type="range"]:focus::-moz-range-thumb,
      .modal-card input[type="range"]:hover::-moz-range-thumb {
        border: 2px solid #fff;
        background: var(--accent);
      }
      .modal-card input[type="range"]::-ms-fill-lower {
        background: #222c3a;
        border-radius: 3px;
      }
      .modal-card input[type="range"]::-ms-fill-upper {
        background: #222c3a;
        border-radius: 3px;
      }
      .modal-card input[type="range"]:focus {
        outline: none;
      }
      .modal-card input[type="range"]::-ms-tooltip {
        display: none;
      }
      .modal-card .score-bubble {
        position: absolute;
        top: -32px;
        min-width: 32px;
        padding: 2px 8px;
        border-radius: 8px;
        background: #222c3a;
        color: var(--accent);
        font-size: 15px;
        font-weight: 600;
        box-shadow: 0 2px 8px 0 rgba(2,6,23,0.13);
        pointer-events: none;
        opacity: 0;
        transform: translateX(-50%) scale(0.95);
        transition: opacity 0.18s, transform 0.18s, left 0.12s;
        z-index: 2;
        left: 0;
      }
      .modal-card .score-slider-wrap.active .score-bubble {
        opacity: 1;
        transform: translateX(-50%) scale(1);
      }
      .modal-card .score-slider-wrap {
        position: relative;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .power-card {
        background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
        padding: 14px 16px 12px 16px;
        border-radius: 12px;
        box-shadow: 0 6px 18px rgba(2, 6, 23, 0.10);
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-bottom: 0px;
      }
      .power-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 2px;
      }
      .power-card table {
        width: 100%;
        border-collapse: collapse;
      }
      .power-card th, .power-card td {
        padding: 2px 4px;
        text-align: left;
      }
      .power-card tr:nth-child(even) td {
        background: rgba(255,255,255,0.02);
      }
      .power-card tr.now td {
        background: var(--accent);
        color: #041124;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>Inicio personal</h1>
      </header>

      <div class="top">
        <div class="search-card">
          <form id="googleForm" class="search" onsubmit="return false;">
            <input
              id="googleQuery"
              placeholder="Buscar en Google..."
              autocomplete="off"
            />
            <button id="btnSearch">Buscar</button>
          </form>
          <div class="hint">
            Pulsa Enter o el botón. El buscador abre los resultados in nueva
            pestaña.
          </div>
        </div>

        <div class="weather-card">
          <div class="weather-top">
            <div>
              <div style="font-size: 13px; color: var(--muted)">Tiempo</div>
              <div class="temp" id="wTemp">-- °C</div>
              <div class="cond" id="wDesc">Sin datos</div>
            </div>
            <div style="text-align: right">
              <div style="color: var(--muted); font-size: 12px">Ubicación</div>
              <div id="wPlace" style="font-weight: 600; color: #fff">
                No especificada
              </div>
            </div>
          </div>

          <div class="weather-controls">
            <button id="btnGeo" class="btn">Usar geolocalización</button>
            <input id="inpLat" placeholder="Lat" />
            <input id="inpLon" placeholder="Lon" />
            <button id="btnFetchWeather" class="btn">Actualizar</button>
          </div>
          <div style="font-size: 12px; color: var(--muted); margin-top: 6px">
            Consejo: guarda coordenadas si quieres una localización fija.
          </div>
        </div>
      </div>

      <section class="games">
        <div class="games-header">
          <h2 style="color: #fff; margin: 0">Juegos finalizados</h2>
          <div style="display: flex; gap: 8px; align-items: center">
            <button id="btnAdd" class="small">Añadir juego</button>
            <button id="btnExport" class="small">Exportar JSON</button>
            <label
              class="small"
              style="
                display: inline-flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
              "
            >
              <input
                id="fileImport"
                type="file"
                accept="application/json"
                style="display: none"
              />Importar
            </label>
          </div>
        </div>

        <div class="games-list" id="gamesList"></div>
      </section>

      <footer>Hecho para uso personal — versión prototipo.</footer>
    </div>

    <!-- modal form -->
    <div id="modal" class="modal" role="dialog" aria-hidden="true">
      <div class="modal-card">
        <h3 id="modalTitle">Añadir juego</h3>
        <form id="gameForm">
          <label>Título</label>
          <input id="gTitle" required />
          <div class="row">
            <div>
              <label>Plataforma</label>
              <select id="gPlatform">
                <option value="">Selecciona plataforma</option>
                <option>PC</option>
                <option>PlayStation 5</option>
                <option>PlayStation 4</option>
                <option>PlayStation 3</option>
                <option>Xbox Series X|S</option>
                <option>Xbox One</option>
                <option>Xbox 360</option>
                <option>Nintendo Switch</option>
                <option>Wii U</option>
                <option>Wii</option>
                <option>Nintendo 3DS</option>
                <option>Nintendo DS</option>
                <option>Android</option>
                <option>iOS</option>
                <option>Steam Deck</option>
                <option>Otro</option>
              </select>
            </div>
            <div>
              <label>Fecha finalizado</label>
              <input id="gDate" type="date" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Puntuación (0-100)</label>
              <div class="score-slider-wrap" style="flex:1;">
                <input id="gScore" type="range" min="0" max="100" step="1" value="0" />
                <span class="score-bubble" id="gScoreBubble">0</span>
                <span id="gScoreValue" style="min-width:36px;text-align:right;font-size:15px;color:var(--accent);font-weight:600;position:relative;top:1px;">0</span>
              </div>
            </div>
            <div>
              <label>Horas jugadas</label>
              <input id="gHours" type="number" min="0" />
            </div>
          </div>
          <label
            >Cover URL (opcional) — Si lo dejas vacío buscaré automáticamente la
            portada.</label
          >
          <input id="gCover" placeholder="https://...jpg" />
          <div
            style="
              display: flex;
              gap: 8px;
              margin-top: 6px;
              align-items: center;
            "
          >
            <button type="button" id="btnFindCover" class="small">
              Buscar portada ahora
            </button>
            <div id="coverStatus" style="font-size: 13px; color: var(--muted)">
              Estado: sin buscar
            </div>
          </div>
          <label>Notas</label>
          <textarea id="gNotes" rows="3"></textarea>

          <div
            style="
              display: flex;
              gap: 8px;
              justify-content: flex-end;
              margin-top: 12px;
            "
          >
            <button type="button" id="btnCancel" class="small">Cancelar</button>
            <button type="submit" class="small">Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal de confirmación para eliminar juego -->
    <div id="confirmModal" class="modal" role="dialog" aria-hidden="true">
      <div class="modal-card" style="max-width:340px;padding:28px 24px;text-align:center;">
        <div style="font-size:18px;font-weight:600;color:#fff;margin-bottom:10px;">¿Eliminar juego?</div>
        <div id="confirmGameTitle" style="color:var(--muted);font-size:15px;margin-bottom:18px;"></div>
        <div style="display:flex;gap:12px;justify-content:center;">
          <button id="btnConfirmDelete" class="small" style="background:#ef4444;color:#fff;min-width:80px;">Eliminar</button>
          <button id="btnCancelDelete" class="small" style="background:#222c3a;color:#fff;min-width:80px;">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Firebase App (core) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <!-- Firebase Realtime Database -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    <script>
      // --- CONFIG ---
      // --- FIREBASE CONFIG ---
      // Rellena con tus datos reales de Firebase Console
      const firebaseConfig = {
        apiKey: "TU_API_KEY",
        authDomain: "juegos-completados-a3005.firebaseapp.com",
        databaseURL: "https://juegos-completados-a3005-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "juegos-completados-a3005",
        storageBucket: "juegos-completados-a3005.appspot.com",
        messagingSenderId: "TU_MESSAGING_SENDER_ID",
        appId: "TU_APP_ID"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      // RAWG API: opcional. Si tienes una API KEY de rawg.io, pégala aquí para mayor fiabilidad.
      // Si lo dejas vacío intentaremos la petición sin clave (puede funcionar o no dependiendo de RAWG en ese momento).
      const RAWG_API_KEY = "f9f8f4e16c9740248b1c67e71720e801"; // clave proporcionada por el usuario (se ha eliminado un posible ':' inicial)

      // --- Utilidad: debounce para evitar muchas peticiones mientras el usuario escribe ---
      function debounce(fn, wait) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), wait);
        };
      }

      // Nota: debajo, en DOMContentLoaded, se añade un listener "debounced" que intentará
      // buscar automáticamente la portada cuando escribas el título y el campo Cover esté vacío.

      // --- Constantes ---
      // const STORAGE_KEY = "homepage_games_v1";
      const WEATHER_KEY = "homepage_weather_loc";
      let games = [];
      let editingId = null;

      // Cache en memoria para portadas buscadas en esta sesión
      const coverCache = {};

      // --- Helpers ---
      const $ = (sel) => document.querySelector(sel);
      const fmtDate = (d) =>
        d ? new Date(d).toLocaleDateString("es-ES") : "-";

      function escapeHtml(s) {
        if (!s) return "";
        return String(s).replace(/[&<>"']/g, function (m) {
          return {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
          }[m];
        });
      }

      // --- Weather mapping (Open-Meteo) ---
      const weatherCodes = {
        0: "Cielo despejado",
        1: "Principalmente despejado",
        2: "Parcialmente nublado",
        3: "Nublado",
        45: "Niebla",
        48: "Neblina con depósitos de hielo",
        51: "Llovizna ligera",
        53: "Llovizna moderada",
        55: "Llovizna densa",
        61: "Lluvia ligera",
        63: "Lluvia moderada",
        65: "Lluvia intensa",
        71: "Nieve ligera",
        73: "Nieve moderada",
        75: "Nieve intensa",
        80: "Chubascos ligeros",
        81: "Chubascos",
        82: "Chubascos intensos",
        95: "Tormenta",
        96: "Tormenta con granizo ligero",
        99: "Tormenta con granizo fuerte",
      };

      // --- Storage ---
      // --- Firebase: cargar y guardar juegos ---
      function loadGames() {
        db.ref('games').once('value').then(snapshot => {
          games = snapshot.val() || [];
          renderGames();
        }).catch(() => {
          games = [];
          renderGames();
        });
      }
      function saveGames() {
        db.ref('games').set(games);
      }

      // --- Render ---
      function renderGames() {
        const container = $("#gamesList");
        container.innerHTML = "";
        if (!games.length) {
          container.innerHTML =
            '<div style="color:var(--muted)">No hay juegos todavía. Añade el primero.</div>';
          return;
        }
        const sorted = [...games].sort((a, b) =>
          (b.date || "").localeCompare(a.date || "")
        );
        for (const g of sorted) {
          const div = document.createElement("div");
          div.className = "game";
          // Color score: de rojo (#ef4444) a verde (#22c55e)
          let scoreColor = '#9aa4b2';
          if (typeof g.score === 'number') {
            // Interpolación lineal entre rojo y verde
            const r1=239,g1=68,b1=68, r2=34,g2=197,b2=94;
            const t = Math.max(0, Math.min(1, g.score/100));
            const r = Math.round(r1 + (r2 - r1) * t);
            const gC = Math.round(g1 + (g2 - g1) * t);
            const b = Math.round(b1 + (b2 - b1) * t);
            scoreColor = `rgb(${r},${gC},${b})`;
          }
          div.innerHTML = `
            <div class="cover">
              ${g.cover
                ? `<img src="${g.cover}" alt="cover">`
                : `<div class="no-cover">No cover</div>`
              }
            </div>
            <div class="info">
              <h3>${escapeHtml(g.title)}</h3>
              <div class="meta">
                <span>${escapeHtml(g.platform || "Sin plataforma")}</span>
                <span>${fmtDate(g.date)}</span>
                <span class="score" style="color:${scoreColor};background:rgba(255,255,255,0.10)">${g.score ?? "-"}</span>
              </div>
              <div class="notes">${escapeHtml(g.notes || "").slice(0, 180)}</div>
            </div>
            <div class="actions">
              <button class="small" onclick="openEdit('${g.id}')">Editar</button>
              <button class="small" onclick="deleteGame('${g.id}')">Borrar</button>
            </div>
          `;
          container.appendChild(div);
        }
      }

      // --- CRUD ---
      function addGame(payload) {
        const entry = Object.assign({
          id: String(Date.now()),
          title: payload.title || "Sin título",
          platform: payload.platform || "",
          date: payload.date || "",
          score: payload.score !== undefined ? Number(payload.score) : null,
          hours: payload.hours || null,
          cover: payload.cover || "",
          notes: payload.notes || "",
        });
        games.push(entry);
        saveGames();
        renderGames();
      }
      function updateGame(id, payload) {
        const idx = games.findIndex((x) => x.id === id);
        if (idx === -1) return;
        games[idx] = Object.assign({}, games[idx], payload);
        saveGames();
        renderGames();
      }
      let pendingDeleteId = null;
      function deleteGame(id) {
        const g = games.find(x => x.id === id);
        if (!g) return;
        pendingDeleteId = id;
        document.getElementById('confirmGameTitle').textContent = g.title ? `"${g.title}"` : '';
        document.getElementById('confirmModal').classList.add('show');
        document.getElementById('confirmModal').setAttribute('aria-hidden', 'false');
      }
      function closeConfirmModal() {
        document.getElementById('confirmModal').classList.remove('show');
        document.getElementById('confirmModal').setAttribute('aria-hidden', 'true');
        pendingDeleteId = null;
      }

      function openEdit(id) {
        const g = games.find((x) => x.id === id);
        if (!g) return;
        editingId = id;
        $("#modalTitle").textContent = "Editar juego";
        $("#gTitle").value = g.title;
        $("#gPlatform").value = g.platform || "";
        $("#gDate").value = g.date || "";
        $("#gScore").value = g.score ?? 0;
        updateScoreUI(g.score ?? 0);
        $("#gHours").value = g.hours ?? "";
        $("#gCover").value = g.cover || "";
        $("#gNotes").value = g.notes || "";
        $("#coverStatus").textContent = g.cover
          ? "Portada ya presente"
          : "Sin portada";
        $("#modal").classList.add("show");
        $("#modal").setAttribute("aria-hidden", "false");
      }

      // --- Export / Import ---
      function exportJSON() {
        const blob = new Blob([JSON.stringify(games, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "juegos_export.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
      function importJSON(file) {
        const r = new FileReader();
        r.onload = (e) => {
          try {
            const parsed = JSON.parse(e.target.result);
            if (!Array.isArray(parsed)) throw new Error("Formato inválido");
            for (const p of parsed) {
              if (!p.title) p.title = "Sin título";
              if (!p.id) p.id = String(Date.now() + Math.random());
            }
            games = parsed;
            saveGames();
            renderGames();
            alert("Importado correctamente");
          } catch (err) {
            alert("Error al importar: " + err.message);
          }
        };
        r.readAsText(file);
      }

      // --- RAWG cover search ---
      async function fetchCoverRAWG(title) {
        const q = title && title.trim();
        if (!q) return null;
        if (coverCache[q]) return coverCache[q];

        // Construimos URL. RAWG espera key=<API_KEY> si la tienes.
        const base = "https://api.rawg.io/api/games";
        const params = new URLSearchParams({ search: q, page_size: "1" });
        if (RAWG_API_KEY) params.set("key", RAWG_API_KEY);
        const url = `${base}?${params.toString()}`;

        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error("RAWG no responde: " + res.status);
          const data = await res.json();
          if (data && data.results && data.results.length) {
            const r = data.results[0];
            // RAWG suele devolver `background_image`. También intentamos screenshots si no hay.
            const img =
              r.background_image ||
              (r.short_screenshots &&
                r.short_screenshots[0] &&
                r.short_screenshots[0].image) ||
              null;
            coverCache[q] = img; // puede ser null
            return img;
          }
        } catch (err) {
          console.warn("Error buscando portada RAWG:", err);
        }
        coverCache[q] = null;
        return null;
      }

      // --- Weather ---
      async function fetchWeather(lat, lon) {
        try {
          $("#wTemp").textContent = "...";
          $("#wDesc").textContent = "Cargando...";
          const url = `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(
            lat
          )}&longitude=${encodeURIComponent(
            lon
          )}&current_weather=true&temperature_unit=celsius&timezone=auto`;
          const res = await fetch(url);
          if (!res.ok) throw new Error("Respuesta del servidor no válida");
          const data = await res.json();
          if (data && data.current_weather) {
            const cw = data.current_weather;
            $("#wTemp").textContent = Math.round(cw.temperature) + " °C";
            $("#wDesc").textContent =
              (weatherCodes[cw.weathercode] || "Condición #" + cw.weathercode) +
              " · velocidad " +
              cw.windspeed +
              " m/s";
            $("#wPlace").textContent = `Lat ${lat.toFixed(
              4
            )}, Lon ${lon.toFixed(4)}`;
            localStorage.setItem(WEATHER_KEY, JSON.stringify({ lat, lon }));
          } else {
            $("#wDesc").textContent = "No hay datos actuales";
          }
        } catch (err) {
          $("#wDesc").textContent = "Error al obtener tiempo";
          console.error(err);
        }
      }

      function tryLoadWeatherFromStorage() {
        const raw = localStorage.getItem(WEATHER_KEY);
        if (!raw) return false;
        try {
          const s = JSON.parse(raw);
          if (s.lat && s.lon) {
            $("#inpLat").value = s.lat;
            $("#inpLon").value = s.lon;
            fetchWeather(Number(s.lat), Number(s.lon));
            return true;
          }
        } catch (e) {}
        return false;
      }

      // Mostrar por defecto el tiempo de Madrid Legazpi si no hay localización guardada
      function showDefaultWeatherIfNeeded() {
        const loaded = tryLoadWeatherFromStorage();
        if (!loaded) {
          const lat = 40.3989;
          const lon = -3.6944;
          $("#inpLat").value = lat;
          $("#inpLon").value = lon;
          fetchWeather(lat, lon);
        }
      }

      // --- Events and init ---
      document.addEventListener("DOMContentLoaded", () => {
        loadGames();
        renderGames();

        // search
        $("#btnSearch").addEventListener("click", doSearch);
        $("#googleQuery").addEventListener("keydown", (e) => {
          if (e.key === "Enter") doSearch();
        });

        // modal
        $("#btnAdd").addEventListener("click", () => {
          editingId = null;
          $("#modalTitle").textContent = "Añadir juego";
          $("#gameForm").reset();
          // Establecer la fecha actual por defecto
          const today = new Date().toISOString().slice(0, 10);
          $("#gDate").value = today;
          $("#coverStatus").textContent = "sin buscar";
          // Resetear el valor del slider y el span
          $("#gScore").value = 0;
          $("#gScoreValue").textContent = 0;
          updateScoreUI(0);
          $("#modal").classList.add("show");
          $("#modal").setAttribute("aria-hidden", "false");
          $("#gTitle").focus();
        });
        $("#btnCancel").addEventListener("click", () => {
          $("#modal").classList.remove("show");
          $("#modal").setAttribute("aria-hidden", "true");
        });

        // Buscar portada ahora
        $("#btnFindCover").addEventListener("click", async () => {
          const title = $("#gTitle").value.trim();
          if (!title) {
            alert("Introduce primero el título");
            return;
          }
          $("#coverStatus").textContent = "Buscando...";
          try {
            const img = await fetchCoverRAWG(title);
            if (img) {
              $("#gCover").value = img;
              $("#coverStatus").textContent = "Portada encontrada";
            } else {
              $("#coverStatus").textContent =
                "No encontrada (usa URL manualmente o guarda y luego edita)";
            }
          } catch (e) {
            $("#coverStatus").textContent = "Error al buscar";
            console.error(e);
          }
        });

        // --- Auto-search de portada mientras escribes (debounced) ---
        const tryAutoFindCover = debounce(async () => {
          const title = $("#gTitle").value.trim();
          if (!title) {
            $("#coverStatus").textContent = "sin buscar";
            return;
          }
          // si el usuario ya ha puesto una URL manual, respetarla
          if ($("#gCover").value.trim()) {
            $("#coverStatus").textContent = "URL manual presente";
            return;
          }
          $("#coverStatus").textContent = "Buscando...";
          try {
            const img = await fetchCoverRAWG(title);
            if (img) {
              $("#gCover").value = img;
              $("#coverStatus").textContent = "Portada encontrada (auto)";
            } else {
              $("#coverStatus").textContent = "No encontrada automáticamente";
            }
          } catch (err) {
            $("#coverStatus").textContent = "Error al buscar (auto)";
            console.warn(err);
          }
        }, 900);

        // activamos el auto-search solo cuando el modal está abierto
        $("#gTitle").addEventListener("input", () => {
          if (document.getElementById("modal").classList.contains("show"))
            tryAutoFindCover();
        });

        // form submit: si no hay cover, intentamos buscar automáticamente antes de guardar
        $("#gameForm").addEventListener("submit", async (e) => {
          e.preventDefault();
          const payload = {
            title: $("#gTitle").value.trim(),
            platform: $("#gPlatform").value.trim(),
            date: $("#gDate").value || "",
            score: $("#gScore").value ? Number($("#gScore").value) : null,
            hours: $("#gHours").value ? Number($("#gHours").value) : null,
            cover: $("#gCover").value.trim(),
            notes: $("#gNotes").value.trim(),
          };

          // Si no hay portada y hay título, intentar buscar antes de guardar
          if (!payload.cover && payload.title) {
            $("#coverStatus").textContent = "Buscando portada...";
            try {
              const img = await fetchCoverRAWG(payload.title);
              if (img) {
                payload.cover = img;
                $("#coverStatus").textContent = "Portada encontrada y asignada";
              } else {
                $("#coverStatus").textContent =
                  "No se encontró portada automáticamente";
              }
            } catch (err) {
              console.warn(err);
              $("#coverStatus").textContent = "Error buscando portada";
            }
          }

          if (editingId) {
            updateGame(editingId, payload);
            editingId = null;
          } else {
            addGame(payload);
          }
          $("#modal").classList.remove("show");
          $("#modal").setAttribute("aria-hidden", "true");
        });

        // export/import
        $("#btnExport").addEventListener("click", exportJSON);
        $("#fileImport").addEventListener("change", (e) => {
          const f = e.target.files[0];
          if (f) importJSON(f);
          e.target.value = "";
        });

        // weather
        $("#btnGeo").addEventListener("click", () => {
          if (!navigator.geolocation) {
            alert("Geolocalización no disponible en este navegador");
            return;
          }
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const lat = pos.coords.latitude;
              const lon = pos.coords.longitude;
              $("#inpLat").value = lat;
              $("#inpLon").value = lon;
              fetchWeather(lat, lon);
            },
            (err) => {
              alert("Error geolocalización: " + err.message);
            }
          );
        });
        $("#btnFetchWeather").addEventListener("click", () => {
          const lat = parseFloat($("#inpLat").value);
          const lon = parseFloat($("#inpLon").value);
          if (Number.isFinite(lat) && Number.isFinite(lon)) {
            fetchWeather(lat, lon);
          } else {
            alert("Introduce coordenadas válidas");
          }
        });

        // try load saved loc
        tryLoadWeatherFromStorage();
        // mostrar por defecto el tiempo de Madrid Legazpi si no hay localización guardada
        showDefaultWeatherIfNeeded();

        // focus shortcuts
        document.addEventListener("keydown", (e) => {
          if (
            e.key === "/" &&
            document.activeElement.tagName !== "INPUT" &&
            document.activeElement.tagName !== "TEXTAREA"
          ) {
            e.preventDefault();
            $("#googleQuery").focus();
          }
        });

        // Confirmación de borrado
        document.getElementById('btnCancelDelete').addEventListener('click', closeConfirmModal);
        document.getElementById('confirmModal').addEventListener('click', (e) => {
          if (e.target === document.getElementById('confirmModal')) closeConfirmModal();
        });
        document.getElementById('btnConfirmDelete').addEventListener('click', () => {
          if (pendingDeleteId) {
            games = games.filter(x => x.id !== pendingDeleteId);
            saveGames();
            renderGames();
            closeConfirmModal();
          }
        });
      });

      // --- Slider puntuación: sincronizar valor y burbuja ---
      function updateScoreUI(val) {
        const scoreSlider = document.getElementById("gScore");
        const scoreValue = document.getElementById("gScoreValue");
        const scoreBubble = document.getElementById("gScoreBubble");
        const scoreWrap = scoreSlider ? scoreSlider.closest('.score-slider-wrap') : null;
        if (!scoreSlider || !scoreValue || !scoreBubble || !scoreWrap) return;
        scoreValue.textContent = val;
        scoreBubble.textContent = val;
        // Calcular la posición de la burbuja sobre el thumb
        const min = Number(scoreSlider.min);
        const max = Number(scoreSlider.max);
        const percent = (val - min) / (max - min);
        const sliderRect = scoreSlider.getBoundingClientRect();
        const wrapRect = scoreWrap.getBoundingClientRect();
        // El thumb se mueve dentro del slider, hay que compensar el padding y el ancho del thumb
        const thumbWidth = 16; // igual que en el CSS
        const usableWidth = sliderRect.width - thumbWidth;
        let px = percent * usableWidth + thumbWidth / 2;
        // Limitar para que no se salga
        px = Math.max(thumbWidth / 2, Math.min(sliderRect.width - thumbWidth / 2, px));
        scoreBubble.style.left = px + 'px';
      }

      // Slider puntuación: sincronizar valor y burbuja
      const scoreSlider = $("#gScore");
      const scoreValue = $("#gScoreValue");
      const scoreBubble = $("#gScoreBubble");
      const scoreWrap = scoreSlider.closest('.score-slider_wrap');
      scoreSlider.addEventListener("input", (e) => {
        updateScoreUI(e.target.value);
      });
      scoreSlider.addEventListener("mousedown", () => {
        scoreWrap.classList.add('active');
        updateScoreUI(scoreSlider.value);
      });
      scoreSlider.addEventListener("touchstart", () => {
        scoreWrap.classList.add('active');
        updateScoreUI(scoreSlider.value);
      });
      ["mouseup","mouseleave","touchend","blur"].forEach(ev => {
        scoreSlider.addEventListener(ev, () => {
          scoreWrap.classList.remove('active');
          updateScoreUI(scoreSlider.value);
        });
      });
      // Recalcular posición de la burbuja al abrir la modal o al redimensionar
      const modal = document.getElementById('modal');
      const observer = new MutationObserver(() => {
        if (modal.classList.contains('show')) {
          setTimeout(() => updateScoreUI(scoreSlider.value), 10);
        }
      });
      observer.observe(modal, { attributes: true, attributeFilter: ['class'] });
      window.addEventListener('resize', () => updateScoreUI(scoreSlider.value));
      // Inicializar posición y valor
      updateScoreUI(scoreSlider.value);

      function doSearch() {
        const q = $("#googleQuery").value.trim();
        if (!q) return;
        const url = "https://www.google.com/search?q=" + encodeURIComponent(q);
        window.open(url, "_blank");
      }

      // Exponer funciones para botones que usan onclick="..."
      window.openEdit = openEdit;
      window.deleteGame = deleteGame;
    </script>
  </body>
</html>
